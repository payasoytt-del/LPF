import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInWithCustomToken, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
} from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, onSnapshot, query, orderBy, serverTimestamp, runTransaction } from 'firebase/firestore';
import { 
  LogIn, LogOut, Loader2, ArrowUp, ArrowDown, Shuffle, Trophy, TrendingUp, TrendingDown, Clock, User, Settings, Plus, X 
} from 'lucide-react';

// --- CONFIGURACIÓN DE FIREBASE Y DATOS INICIALES ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Inicializa Firebase
const app = Object.keys(firebaseConfig).length ? initializeApp(firebaseConfig) : null;
const db = app ? getFirestore(app) : null;
const auth = app ? getAuth(app) : null;

// Equipos fijos (Canon)
const CANONICAL_TEAMS = {
    "Liga Profesional": [
        "Atlético Tucumán", "Argentinos Juniors", "Banfield", "Barracas Central", "Belgrano",
        "Boca Juniors", "Central Córdoba (SdE)", "Defensa y Justicia", "Deportivo Riestra", "Estudiantes de La Plata",
        "Gimnasia y Esgrima (LP)", "Godoy Cruz", "Huracán", "Independiente", "Independiente Rivadavia",
        "Instituto", "Lanús", "Newell's Old Boys", "Platense", "Racing Club",
        "River Plate", "Rosario Central", "San Lorenzo", "San Martín (SJ) [LP]", "Sarmiento",
        "Talleres (C)", "Tigre", "Unión", "Vélez Sarsfield", "Aldosivi"
    ],
    "Primera Nacional": [
        "Agropecuario", "Almagro", "All Boys", "Almirante Brown", "Alvarado",
        "Arsenal", "Atlanta", "CADU (Zárate)", "Central Norte", "Chacarita Juniors",
        "Chaco For Ever", "Colegiales", "Colón", "Defensores de Belgrano", "Deportivo Madryn",
        "Deportivo Maipú", "Deportivo Morón", "Estudiantes (BA)", "Estudiantes (RC)", "Ferro Carril Oeste",
        "Gimnasia y Esgrima (M)", "Gimnasia y Tiro (S)", "Güemes (SdE)", "Los Andes", "Mitre (SdE)",
        "Nueva Chicago", "Patronato", "Quilmes", "Racing (Cba)", "San Martín (SJ) [PN]",
        "San Martín (T)", "San Miguel", "San Telmo", "Talleres (RE)", "Temperley",
        "Tristán Suárez"
    ],
    "Primera B Metro": [
        "Acassuso", "Argentino de Merlo", "Argentino de Quilmes", "Brown de Adrogué", "Comunicaciones",
        "CSD Liniers", "Deportivo Armenio", "Deportivo Merlo", "Dock Sud", "Excursionistas",
        "Fénix", "Flandria", "FC Midland", "Deportivo Laferrere", "Real Pilar",
        "Sacachispas", "San Martín (B)", "Sportivo Italiano", "UAI Urquiza", "Villa Dálmine",
        "Villa San Carlos"
    ],
    "Federal A": [
        "9 de Julio (Rafaela)", "Atenas (RC)", "Atlético de Rafaela", "Atlético San Martín (M)", "Bartolomé Mitre",
        "Ben Hur", "Boca Unidos", "Círculo Deportivo Otamendi", "Cipolletti", "Ciudad de Bolívar",
        "Costa Brava (LP)", "Crucero del Norte", "Defensores de Belgrano (VR)", "Deportivo Argentino", "Deportivo Rincón",
        "Douglas Haig", "El Linqueño", "Gimnasia y Esgrima (Ch)", "Gimnasia y Esgrima (CdU)", "Germinal",
        "Guillermo Brown", "Gutiérrez Sport Club", "Huracán Las Heras", "Independiente (Chivilcoy)", "Juventud Antoniana",
        "Juventud Unida Universitario", "Kimberley", "Olimpo", "Ramón Santamarina", "San Martín (F)",
        "Sarmiento (LB)", "Sarmiento (R)", "Sol de América", "Sol de Mayo", "Sportivo Belgrano",
        "Sportivo Estudiantes", "Sportivo Las Parejas", "Villa Mitre"
    ],
    "Primera C": [
        "Argentino (R)", "Atlas", "Berazategui", "Cañuelas", "Camioneros",
        "Central Ballester", "Central Córdoba (R)", "Centro Español", "Claypole", "Defensores de Cambaceres",
        "Deportivo Español", "Deportivo Paraguayo", "El Porvenir", "Estrella del Sur", "General Lamadrid",
        "Ituzaingó", "Justo José de Urquiza", "Juventud Unida", "Leandro N. Alem", "Lugano",
        "Luján", "Mercedes", "Muñiz", "Puerto Nuevo", "Sportivo Barracas",
        "Victoriano Arenas", "Yupanqui"
    ],
    "Promocional Amateur": [
        "Atlético Pilar", "Barrancas FC", "Belgrano de Zárate", "Defensores de Glew", "Deportivo Metalúrgico",
        "Estrella de Berisso", "Everton de La Plata", "Ezeiza FC", "Juventud de Bernal", "Náutico Hacoaj",
        "Provincial de Lobos", "SAT (Sindicato Argentino de Televisión)"
    ]
};

// Estructura de Liga Inicial (Mantiene los tiers que sugirió el usuario)
const getInitialLeagueStructure = () => [
    { id: 'div-1', name: "Liga Profesional", order: 1, teams: CANONICAL_TEAMS["Liga Profesional"], ascend: 0, descend: 2 },
    { id: 'div-2', name: "Primera Nacional", order: 2, teams: CANONICAL_TEAMS["Primera Nacional"], ascend: 2, descend: 2 },
    { id: 'div-3A', name: "Primera B Metro", order: 3, teams: CANONICAL_TEAMS["Primera B Metro"], ascend: 1, descend: 1 },
    { id: 'div-3B', name: "Federal A", order: 3, teams: CANONICAL_TEAMS["Federal A"], ascend: 1, descend: 1 },
    { id: 'div-4', name: "Primera C", order: 4, teams: CANONICAL_TEAMS["Primera C"], ascend: 2, descend: 1 },
    { id: 'div-5', name: "Promocional Amateur", order: 5, teams: CANONICAL_TEAMS["Promocional Amateur"], ascend: 1, descend: 1 },
];

// --- FUNCIONES DE UTILIDAD DE FIREBASE ---
const getLeagueDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/league/current`);
const getHistoryCollectionRef = () => collection(db, `artifacts/${appId}/public/data/championship_history`);

// Genera un ID corto para las nuevas divisiones
const generateNewDivisionId = (order) => `div-new-${order}-${Date.now().toString().slice(-4)}`;

// --- COMPONENTE PRINCIPAL APP ---

const App = () => {
    const [leagueStructure, setLeagueStructure] = useState([]);
    const [currentDivisionId, setCurrentDivisionId] = useState(null);
    const [user, setUser] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isSimulating, setIsSimulating] = useState(false);
    const [history, setHistory] = useState([]);
    const [error, setError] = useState(null);
    const [isConfigMode, setIsConfigMode] = useState(false);
    const [draggedItem, setDraggedItem] = useState(null);

    // --- 1. AUTENTICACIÓN Y CARGA DE DATOS ---

    const handleGoogleSignIn = async () => {
        if (!auth) return;
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Error al iniciar sesión con Google:", error);
            setError("Fallo al iniciar sesión con Google.");
        }
    };

    const handleSignOut = async () => {
        if (!auth) return;
        try {
            await signOut(auth);
            setUser(null);
            setError(null);
        } catch (error) {
            console.error("Error al cerrar sesión:", error);
        }
    };
    
    // 1a. Inicialización de Auth
    useEffect(() => {
        if (!app) { setError("Firebase no inicializado."); setIsAuthReady(true); return; }

        const authenticate = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Error al autenticar:", err);
            }
        };
        authenticate();

        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            setIsAuthReady(true);
        });

        return () => unsubscribe();
    }, []);

    // 1b. Carga y Sincronización de la Estructura de Liga
    useEffect(() => {
        if (!db || !user) return;

        const leagueRef = getLeagueDocRef(user.uid);
        
        const unsubscribe = onSnapshot(leagueRef, async (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data().structure;
                setLeagueStructure(data);
                if (!currentDivisionId && data.length > 0) {
                    setCurrentDivisionId(data[0].id);
                }
            } else {
                // Si no existe, crear la estructura inicial
                const initialStructure = getInitialLeagueStructure();
                await setDoc(leagueRef, {
                    structure: initialStructure,
                    userId: user.uid,
                    lastUpdated: serverTimestamp()
                });
                setLeagueStructure(initialStructure);
                if (initialStructure.length > 0) setCurrentDivisionId(initialStructure[0].id);
            }
        }, (err) => {
            console.error("Error cargando estructura de liga:", err);
            setError("Error al cargar la estructura de la liga.");
        });

        return () => unsubscribe();
    }, [db, user]);

    // 1c. Carga del Historial de Campeonatos
    useEffect(() => {
        if (!db) return;
        const q = query(getHistoryCollectionRef(), orderBy("timestamp", "desc"));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const newHistory = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate()
            }));
            setHistory(newHistory);
        }, (err) => {
            console.error("Error cargando historial:", err);
            setError("Error al cargar el historial de simulaciones.");
        });

        return () => unsubscribe();
    }, [db]);

    // --- 2. GESTIÓN DE ESTADO LOCAL Y FIREBASE ---

    // Guarda el estado actual de la estructura de la liga en Firestore
    const saveLeagueStructure = useCallback(async (newStructure) => {
        if (!db || !user) {
            setError("Error: No hay usuario autenticado o DB no está lista.");
            return;
        }
        try {
            const leagueRef = getLeagueDocRef(user.uid);
            await setDoc(leagueRef, {
                structure: newStructure,
                userId: user.uid,
                lastUpdated: serverTimestamp()
            }, { merge: true });
            setLeagueStructure(newStructure);
        } catch (e) {
            console.error("Error al guardar la estructura:", e);
            setError("Error al guardar los cambios en la nube.");
        }
    }, [db, user]);

    // Actualiza la lista de equipos y guarda
    const updateDivisionTeams = useCallback((divisionId, newTeams) => {
        const newStructure = leagueStructure.map(div => 
            div.id === divisionId ? { ...div, teams: newTeams } : div
        );
        saveLeagueStructure(newStructure);
    }, [leagueStructure, saveLeagueStructure]);

    // Mueve un equipo dentro de una división (Drag/Arrow/Input)
    const moveTeamInDivision = useCallback((divisionId, movedTeamName, newIndex) => {
        const division = leagueStructure.find(d => d.id === divisionId);
        if (!division) return;

        const currentTeams = [...division.teams];
        const oldIndex = currentTeams.indexOf(movedTeamName);

        if (oldIndex === newIndex) return;

        const [movedItem] = currentTeams.splice(oldIndex, 1);
        currentTeams.splice(newIndex, 0, movedItem);
        
        updateDivisionTeams(divisionId, currentTeams);
    }, [leagueStructure, updateDivisionTeams]);

    // --- 3. GESTIÓN DE LA CONFIGURACIÓN (Ascensos/Descensos/Divisiones) ---

    const handleRuleChange = (divisionId, rule, value) => {
        const numericValue = parseInt(value, 10) || 0;
        const newStructure = leagueStructure.map(div => 
            div.id === divisionId ? { ...div, [rule]: numericValue } : div
        );
        saveLeagueStructure(newStructure);
    };

    const handleAddDivision = () => {
        const maxOrder = leagueStructure.reduce((max, div) => Math.max(max, div.order), 0);
        const newOrder = maxOrder + 1;
        const newDivision = {
            id: generateNewDivisionId(newOrder),
            name: `División ${newOrder}`,
            order: newOrder,
            teams: [],
            ascend: 1,
            descend: 1,
        };
        const newStructure = [...leagueStructure, newDivision].sort((a, b) => a.order - b.order);
        saveLeagueStructure(newStructure);
    };

    const handleRemoveDivision = (divisionId) => {
        // No permitir eliminar la primera división
        const divisionToRemove = leagueStructure.find(d => d.id === divisionId);
        if (!divisionToRemove || divisionToRemove.order === 1) return;

        if (!confirm(`¿Estás seguro de que quieres eliminar ${divisionToRemove.name}? Los ${divisionToRemove.teams.length} equipos serán transferidos a la división superior.`)) {
            return;
        }

        const teamsToMove = divisionToRemove.teams;
        const newStructure = leagueStructure.filter(div => div.id !== divisionId);

        // Encontrar la división de destino (Tier superior inmediato o el que tenga el mismo 'order')
        const targetOrder = divisionToRemove.order === 1 ? 1 : divisionToRemove.order - 1;
        
        // Encontrar la división de destino más adecuada (la primera con orden menor)
        const targetDivision = newStructure
            .filter(d => d.order < divisionToRemove.order)
            .sort((a, b) => b.order - a.order)[0];

        if (targetDivision) {
             const updatedTargetTeams = [...targetDivision.teams, ...teamsToMove];
             const updatedStructure = newStructure.map(div =>
                 div.id === targetDivision.id ? { ...div, teams: updatedTargetTeams } : div
             );
             saveLeagueStructure(updatedStructure);
        } else {
            // Si es la última división y no hay target (solo queda la primera), mover a la primera.
            const firstDivision = newStructure.find(d => d.order === 1);
            if(firstDivision) {
                const updatedFirstTeams = [...firstDivision.teams, ...teamsToMove];
                const updatedStructure = newStructure.map(div =>
                    div.id === firstDivision.id ? { ...div, teams: updatedFirstTeams } : div
                );
                saveLeagueStructure(updatedStructure);
            } else {
                saveLeagueStructure(newStructure); // Solo elimina
            }
        }
    };


    // --- 4. LÓGICA DE SIMULACIÓN (Transacción Firestore) ---

    const simulateSeason = async () => {
        if (!db || !user || isSimulating) return;

        setIsSimulating(true);
        setError(null);
        
        try {
            await runTransaction(db, async (transaction) => {
                const leagueRef = getLeagueDocRef(user.uid);
                const leagueDoc = await transaction.get(leagueRef);

                if (!leagueDoc.exists) {
                    throw "La estructura de la liga no existe.";
                }

                const currentStructure = leagueDoc.data().structure;
                let newStructure = JSON.parse(JSON.stringify(currentStructure)); // Copia profunda
                const results = {};
                
                // 1. Clonar la estructura ordenada por Tier (order)
                const sortedStructure = [...newStructure].sort((a, b) => a.order - b.order);
                const maxOrder = sortedStructure[sortedStructure.length - 1].order;

                const promotedTeams = [];
                const relegatedTeams = [];

                // 2. Determinar Ascensos y Descensos para todas las divisiones
                for (let i = 0; i < sortedStructure.length; i++) {
                    const currentDiv = sortedStructure[i];
                    const nextDiv = sortedStructure.find(d => d.order === currentDiv.order + 1);
                    const prevDivs = sortedStructure.filter(d => d.order === currentDiv.order - 1);
                    
                    const divTeams = currentDiv.teams;
                    const divResults = { champion: divTeams[0], ascensos: [], descensos: [] };

                    // Ascensos: Los primeros X equipos (X = ascendidos)
                    if (currentDiv.ascend > 0 && prevDivs.length > 0) {
                        const teamsToPromote = divTeams.slice(0, currentDiv.ascend);
                        promotedTeams.push(...teamsToPromote.map(t => ({ name: t, fromId: currentDiv.id, toId: prevDivs[0].id })));
                        divResults.ascensos = teamsToPromote;
                    }

                    // Descensos: Los últimos X equipos (X = descendidos)
                    if (currentDiv.descend > 0) {
                        const teamsToRelegate = divTeams.slice(-currentDiv.descend);
                        relegatedTeams.push(...teamsToRelegate.map(t => ({ name: t, fromId: currentDiv.id, toOrder: currentDiv.order + 1 })));
                        divResults.descensos = teamsToRelegate;
                    }
                    
                    results[currentDiv.name] = divResults;
                }
                
                // 3. Aplicar Movimientos
                
                // Eliminar equipos de sus divisiones originales
                newStructure = newStructure.map(div => {
                    div.teams = div.teams.filter(team => 
                        !promotedTeams.some(p => p.name === team) && 
                        !relegatedTeams.some(r => r.name === team)
                    );
                    return div;
                });

                // Añadir Ascendidos
                promotedTeams.forEach(p => {
                    const targetDiv = newStructure.find(d => d.id === p.toId);
                    if (targetDiv) {
                        targetDiv.teams = [p.name, ...targetDiv.teams]; // Ponerlos al inicio para el ranking
                    }
                });

                // Añadir Descendidos y crear nueva división si es necesario
                const lastDivOrder = sortedStructure[sortedStructure.length - 1].order;

                relegatedTeams.forEach(r => {
                    let targetDiv = newStructure.find(d => d.order === r.toOrder);
                    
                    if (!targetDiv) {
                        // Si no hay división inferior (descenso de la última), crear una nueva
                        const newId = generateNewDivisionId(r.toOrder);
                        targetDiv = {
                            id: newId,
                            name: `División ${r.toOrder}`,
                            order: r.toOrder,
                            teams: [],
                            ascend: 1, 
                            descend: 1,
                        };
                        newStructure.push(targetDiv);
                    }
                    
                    targetDiv.teams = [...targetDiv.teams, r.name]; // Ponerlos al final
                });

                // Guardar la nueva estructura de liga (con equipos movidos)
                transaction.set(leagueRef, {
                    structure: newStructure.sort((a, b) => a.order - b.order),
                    userId: user.uid,
                    lastUpdated: serverTimestamp()
                }, { merge: true });

                // Guardar el historial de campeonatos (público)
                const historyRef = doc(getHistoryCollectionRef());
                transaction.set(historyRef, {
                    year: new Date().getFullYear(),
                    date: serverTimestamp(),
                    user: { id: user.uid, name: user.displayName || 'Anónimo', email: user.email || 'N/A' },
                    results: results,
                    promotedTeams: promotedTeams.map(p => p.name),
                    relegatedTeams: relegatedTeams.map(r => r.name),
                    timestamp: serverTimestamp()
                });
            });

        } catch (err) {
            console.error("Error en la transacción de simulación:", err);
            setError(`Error al simular: ${err.message || 'Verifica la consola.'}`);
        } finally {
            setIsSimulating(false);
        }
    };
    
    // --- COMPONENTES AUXILIARES DE RENDERIZADO ---

    const DivisionConfigPanel = ({ division }) => (
        <div className="bg-gray-100 p-3 rounded-lg border border-gray-300 transition-shadow hover:shadow-md mb-2">
            <div className="flex justify-between items-center mb-2">
                <input
                    type="text"
                    value={division.name}
                    onChange={(e) => {
                        const newStructure = leagueStructure.map(d =>
                            d.id === division.id ? { ...d, name: e.target.value } : d
                        );
                        saveLeagueStructure(newStructure);
                    }}
                    className="text-lg font-semibold w-2/3 bg-transparent border-b border-gray-400 focus:border-indigo-600 outline-none"
                />
                {division.order > 1 && ( // No permitir borrar la primera división
                    <button onClick={() => handleRemoveDivision(division.id)} className="p-1 text-red-500 hover:text-red-700 transition">
                        <X className="w-5 h-5" />
                    </button>
                )}
            </div>
            
            <p className="text-sm text-gray-600 mb-2">Tier: {division.order}. Equipos: {division.teams.length}</p>

            <div className="flex space-x-2">
                <label className="text-sm text-green-700 flex items-center">
                    Ascensos:
                    <input
                        type="number" min="0" value={division.ascend}
                        onChange={(e) => handleRuleChange(division.id, 'ascend', e.target.value)}
                        className="w-12 ml-1 p-1 border rounded text-center text-gray-800"
                    />
                </label>
                <label className="text-sm text-red-700 flex items-center">
                    Descensos:
                    <input
                        type="number" min="0" value={division.descend}
                        onChange={(e) => handleRuleChange(division.id, 'descend', e.target.value)}
                        className="w-12 ml-1 p-1 border rounded text-center text-gray-800"
                    />
                </label>
            </div>
        </div>
    );
    
    const TeamList = ({ division }) => {
        const teams = division.teams;
        
        const handleDragStart = (e, teamName) => {
            setDraggedItem({ name: teamName, fromId: division.id });
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", teamName);
        };
        
        const handleDragOver = (e) => e.preventDefault();
        
        const handleDrop = (e, targetIndex) => {
            e.preventDefault();
            if (!draggedItem || draggedItem.name === teams[targetIndex]) return;

            // Mover dentro de la misma división
            if (draggedItem.fromId === division.id) {
                const oldIndex = teams.indexOf(draggedItem.name);
                moveTeamInDivision(division.id, draggedItem.name, targetIndex);
            } else {
                // Lógica de movimiento entre divisiones (simplemente se añade al destino en la posición targetIndex, y se elimina del origen)
                const sourceDiv = leagueStructure.find(d => d.id === draggedItem.fromId);
                if (sourceDiv) {
                    // Remover del origen
                    const newSourceTeams = sourceDiv.teams.filter(t => t !== draggedItem.name);
                    
                    // Añadir al destino
                    const newTargetTeams = [...teams];
                    newTargetTeams.splice(targetIndex, 0, draggedItem.name);
                    
                    const newStructure = leagueStructure.map(d => {
                        if (d.id === draggedItem.fromId) return { ...d, teams: newSourceTeams };
                        if (d.id === division.id) return { ...d, teams: newTargetTeams };
                        return d;
                    }).sort((a, b) => a.order - b.order);
                    
                    saveLeagueStructure(newStructure);
                }
            }
            setDraggedItem(null);
        };
        
        const moveTeam = (teamName, direction) => {
            const index = teams.indexOf(teamName);
            const newIndex = index + (direction === 'up' ? -1 : 1);
            if (newIndex >= 0 && newIndex < teams.length) {
                moveTeamInDivision(division.id, teamName, newIndex);
            }
        };

        const getRuleBadge = (rank) => {
            if (rank <= division.ascend && division.order > 1) return 'bg-lime-200 text-lime-800 border-lime-500';
            if (rank > teams.length - division.descend) return 'bg-red-200 text-red-800 border-red-500';
            if (rank === 1 && division.order === 1) return 'bg-yellow-200 text-yellow-800 border-yellow-500';
            return 'bg-gray-100 text-gray-700 border-gray-300';
        };

        return (
            <div className="bg-white p-4 rounded-xl shadow-lg h-full">
                <h3 className="text-xl font-bold mb-4 text-gray-800 flex items-center justify-between">
                    {division.name} (Tier {division.order})
                    <Shuffle className="w-5 h-5 text-indigo-500 cursor-pointer hover:rotate-180 transition-transform" onClick={() => updateDivisionTeams(division.id, [...teams].sort(() => Math.random() - 0.5))} title="Reordenar Aleatoriamente" />
                </h3>
                <ul className="space-y-2">
                    {teams.map((team, index) => (
                        <li
                            key={team}
                            draggable
                            onDragStart={(e) => handleDragStart(e, team)}
                            onDragOver={handleDragOver}
                            onDrop={(e) => handleDrop(e, index)}
                            className={`p-3 rounded-lg flex justify-between items-center cursor-move transition-all duration-150 border-l-4 ${getRuleBadge(index + 1)} ${draggedItem && draggedItem.name === team ? 'opacity-50' : 'hover:bg-gray-100'}`}
                        >
                            <div className="flex items-center space-x-3">
                                <span className="w-8 text-center text-lg font-mono font-bold text-gray-800">{index + 1}.</span>
                                <span className="text-sm md:text-base font-medium text-gray-900">{team}</span>
                            </div>
                            <div className="flex items-center space-x-2">
                                {/* Botones de Flecha */}
                                <button
                                    onClick={(e) => { e.stopPropagation(); moveTeam(team, 'up'); }}
                                    disabled={index === 0}
                                    className="p-1.5 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full disabled:text-gray-300 disabled:bg-gray-100 transition-colors"
                                    title="Subir"
                                >
                                    <ArrowUp className="w-4 h-4" />
                                </button>
                                <button
                                    onClick={(e) => { e.stopPropagation(); moveTeam(team, 'down'); }}
                                    disabled={index === teams.length - 1}
                                    className="p-1.5 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full disabled:text-gray-300 disabled:bg-gray-100 transition-colors"
                                    title="Bajar"
                                >
                                    <ArrowDown className="w-4 h-4" />
                                </button>
                            </div>
                        </li>
                    ))}
                    {/* Placeholder para drop al final */}
                    {teams.length === 0 && (
                        <li onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, 0)} className="border-2 border-dashed border-indigo-300 p-8 text-center text-indigo-500 rounded-lg">
                            Arrastra un equipo aquí para añadirlo.
                        </li>
                    )}
                </ul>
            </div>
        );
    };

    if (!isAuthReady) {
        return (
            <div className="flex justify-center items-center h-screen bg-gray-100">
                <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                <span className="ml-3 text-lg font-medium text-gray-700">Cargando datos de la liga...</span>
            </div>
        );
    }
    
    const currentDivision = leagueStructure.find(d => d.id === currentDivisionId);
    const sortedLeague = [...leagueStructure].sort((a, b) => a.order - b.order);

    return (
        <div className="min-h-screen bg-gray-50 font-sans p-4 md:p-8">
            <header className="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-xl shadow-lg mb-6 border-b-4 border-indigo-600">
                <h1 className="text-3xl font-extrabold text-indigo-700 flex items-center">
                    <Trophy className="w-7 h-7 mr-2" />
                    Liga Argentina Simulador Dinámico
                </h1>
                <div className="mt-4 md:mt-0 flex items-center space-x-3">
                    <span className="text-sm font-medium text-gray-600 flex items-center">
                        <User className="w-4 h-4 mr-1" />
                        {user ? user.displayName || user.email?.split('@')[0] || 'Anónimo' : 'Cargando...'}
                    </span>
                    {user && !user.isAnonymous ? (
                        <button onClick={handleSignOut} className="flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors shadow-md">
                            <LogOut className="w-4 h-4 mr-1" /> Cerrar Sesión
                        </button>
                    ) : (
                        <button onClick={handleGoogleSignIn} className="flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                            <LogIn className="w-4 h-4 mr-1" /> Google Sign-In
                        </button>
                    )}
                </div>
            </header>

            {error && (
                <div className="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 shadow-md" role="alert">
                    {error}
                </div>
            )}

            <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Panel de Configuración y Simulación */}
                <div className="lg:col-span-1 space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between border-b pb-2">
                            Configuración de la Liga
                            <button onClick={() => setIsConfigMode(!isConfigMode)} className="p-2 bg-gray-100 rounded-full hover:bg-indigo-100 text-indigo-600 transition">
                                <Settings className="w-5 h-5" />
                            </button>
                        </h2>
                        
                        {/* Selector de División */}
                        <div className={`transition-all duration-300 ${isConfigMode ? 'hidden' : 'block'}`}>
                            <p className="text-sm text-gray-600 mb-2">Selecciona una división para ver/editar su ranking:</p>
                            <div className="grid grid-cols-2 gap-3 max-h-48 overflow-y-auto">
                                {sortedLeague.map(div => (
                                    <button
                                        key={div.id}
                                        onClick={() => setCurrentDivisionId(div.id)}
                                        className={`px-4 py-2 text-sm font-medium rounded-lg transition-all shadow-sm ${currentDivisionId === div.id
                                            ? 'bg-indigo-600 text-white shadow-indigo-400/50'
                                            : 'bg-gray-200 text-gray-700 hover:bg-indigo-100 hover:text-indigo-700'
                                        }`}
                                    >
                                        {div.name} (Tier {div.order})
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Modo de Configuración (Ascensos/Descensos/Eliminar) */}
                        <div className={`transition-all duration-300 ${isConfigMode ? 'block' : 'hidden'}`}>
                            <p className="text-sm text-gray-600 mb-3">Ajusta las reglas de ascenso/descenso y estructura:</p>
                            <div className="max-h-64 overflow-y-auto pr-2">
                                {sortedLeague.map(div => (
                                    <DivisionConfigPanel key={div.id} division={div} />
                                ))}
                            </div>
                            <button onClick={handleAddDivision} className="w-full mt-3 flex items-center justify-center py-2 text-sm font-medium text-indigo-600 border border-indigo-600 rounded-lg hover:bg-indigo-50 transition">
                                <Plus className="w-4 h-4 mr-1" /> Añadir Nueva División
                            </button>
                        </div>
                    </div>
                    
                    {/* Botón de Simulación */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Simular Temporada</h2>
                        <button
                            onClick={simulateSeason}
                            disabled={!user || user.isAnonymous || isSimulating || leagueStructure.length === 0}
                            className={`w-full flex items-center justify-center px-6 py-3 text-lg font-bold rounded-lg transition-all transform shadow-2xl
                                ${isSimulating
                                    ? 'bg-gray-400 text-gray-700'
                                    : 'bg-green-600 text-white hover:bg-green-700 active:scale-98 shadow-green-400/50'
                                }`}
                            title={!user || user.isAnonymous ? "Debes iniciar sesión para guardar simulaciones" : "Simular la temporada en base al ranking y reglas actuales"}
                        >
                            {isSimulating ? (
                                <><Loader2 className="w-5 h-5 mr-2 animate-spin" /> Simulación en curso...</>
                            ) : (
                                <>¡Correr Temporada {new Date().getFullYear()}! </>
                            )}
                        </button>
                        {!user || user.isAnonymous ? (
                            <p className="mt-3 text-xs text-red-500 text-center">Inicia sesión con Google para usar y guardar la configuración.</p>
                        ) : (
                            <p className="mt-3 text-xs text-gray-500 text-center">Las reglas de ascenso/descenso configuradas serán aplicadas.</p>
                        )}
                    </div>
                </div>

                {/* Panel de Ranking de Equipos */}
                <div className="lg:col-span-2">
                    {currentDivision ? (
                        <TeamList division={currentDivision} />
                    ) : (
                        <div className="bg-white p-12 rounded-xl shadow-lg text-center text-gray-500">
                            Selecciona una división o espera a que se cargue la estructura de la liga.
                        </div>
                    )}
                </div>
            </main>

            {/* Historial de Campeonatos */}
            <section className="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
                    <Clock className="w-5 h-5 mr-2" />
                    Historial de Simulaciones
                </h2>
                <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                    {history.length > 0 ? (
                        history.map((sim, index) => (
                            <div key={sim.id} className="p-3 border rounded-lg bg-gray-50 shadow-sm hover:bg-gray-100 transition">
                                <p className="text-xs font-semibold text-indigo-600 mb-1 flex justify-between items-center">
                                    <span>Simulación {history.length - index} | Fecha: {sim.timestamp?.toLocaleDateString()}</span>
                                    <span className="text-gray-500 font-normal">Por: {sim.user.name.split(' ')[0]}</span>
                                </p>
                                <ul className="list-disc pl-5 text-sm space-y-0.5">
                                    {Object.entries(sim.results).map(([divisionName, res]) => (
                                        <li key={divisionName} className="text-gray-700">
                                            <span className="font-medium text-xs">{divisionName}:</span>
                                            <span className="font-bold text-green-700 ml-1">Campeón: {res.champion}</span>
                                            {res.ascensos?.length > 0 && <span className="ml-2 text-xs text-lime-700">(+{res.ascensos.length} Asc)</span>}
                                            {res.descensos?.length > 0 && <span className="ml-1 text-xs text-red-700">(-{res.descensos.length} Desc)</span>}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))
                    ) : (
                        <p className="text-gray-500 text-sm text-center py-4">No hay simulaciones en el historial todavía.</p>
                    )}
                </div>
            </section>
        </div>
    );
};

export default App;
