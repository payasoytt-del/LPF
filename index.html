<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Reestructuración de Fútbol Argentino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Configuración e Inicialización de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de logs en Debug para ver errores de Firebase
        setLogLevel('Debug');

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // Variables globales (proporcionadas por el entorno de Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const SIMULATION_DOC_PATH = `artifacts/${appId}/public/data/league_structure_simulations/arg_league_sim_dynamic`;

        // Estructura inicial por defecto (si no hay datos guardados)
        const defaultStructure = [
            {
                id: 1, name: "Nivel 1: Liga Profesional", divisions: [
                    { id: crypto.randomUUID(), name: "Liga Profesional (30)", teams: ["River Plate", "Boca Juniors", "Racing Club", "Independiente", "San Lorenzo", "Vélez Sarsfield", "Estudiantes de La Plata", "Gimnasia y Esgrima (LP)", "Rosario Central", "Newell's Old Boys", "Lanús", "Godoy Cruz", "Talleres (C)", "Atlético Tucumán", "Unión", "Colón", "Defensa y Justicia", "Huracán", "Argentinos Juniors", "Platense", "Barracas Central", "Tigre", "Arsenal", "Sarmiento", "Central Córdoba (SdE)", "Instituto", "Banfield", "Deportivo Riestra", "Independiente Rivadavia", "Aldosivi"], up: 0, down: 4 }
                ]
            },
            {
                id: 2, name: "Nivel 2: Primera Nacional", divisions: [
                    { id: crypto.randomUUID(), name: "Primera Nacional (36)", teams: ["Quilmes", "Chacarita Juniors", "Deportivo Morón", "San Martín (T)", "Nueva Chicago", "Ferro Carril Oeste", "Temperley", "Almirante Brown", "Patronato", "Guillermo Brown", "Deportivo Madryn", "Gimnasia y Esgrima (M)", "Estudiantes (BA)", "Almagro", "San Telmo", "Racing (Cba)", "Defensores de Belgrano", "Los Andes", "Mitre (SdE)", "San Martín (SJ)", "Chaco For Ever", "Tristán Suárez", "Güemes (SdE)", "Alvarado", "Agropecuario", "CADU (Zárate)", "Talleres (RE)", "Gimnasia y Tiro (S)", "Deportivo Maipú", "Estudiantes (RC)", "San Miguel", "Central Norte", "Colegiales", "Atlanta", "Villa Dálmine", "Flandria"], up: 4, down: 6 }
                ]
            },
            {
                id: 3, name: "Nivel 3: Divisiones Paralelas", divisions: [
                    { id: crypto.randomUUID(), name: "Primera B Metropolitana (21)", teams: ["Deportivo Armenio", "Acassuso", "Comunicaciones", "UAI Urquiza", "Dock Sud", "Villa San Carlos", "Sportivo Italiano", "Deportivo Merlo", "Fénix", "Sacachispas", "Argentino de Merlo", "CSD Liniers", "Excursionistas", "Real Pilar", "Argentino de Quilmes", "Brown de Adrogué", "Deportivo Laferrere", "San Martín (B)", "FC Midland", "Deportivo Español", "Cañuelas"], up: 3, down: 3 },
                    { id: crypto.randomUUID(), name: "Torneo Federal A (38)", teams: ["Olimpo", "Ciudad de Bolívar", "Douglas Haig", "Juventud Unida Universitario", "Villa Mitre", "Gimnasia y Esgrima (CdU)", "Sportivo Belgrano", "Sarmiento (R)", "Central Norte", "Crucero del Norte", "San Martín (F)", "Boca Unidos", "Huracán Las Heras", "Germinal", "Defensores de Belgrano (VR)", "Cipolletti", "Ramón Santamarina", "Sol de América", "El Linqueño", "Sportivo Las Parejas", "Atenas (RC)", "Independiente (Chivilcoy)", "Sportivo Estudiantes", "Kimberley", "Bartolomé Mitre", "Gutiérrez Sport Club", "Deportivo Rincón", "Juventud Antoniana", "Gimnasia y Esgrima (Ch)", "Círculo Deportivo Otamendi", "Sarmiento (LB)", "Atlético San Martín (M)", "Sol de Mayo", "Ben Hur", "Costa Brava (LP)", "Atlético de Rafaela", "Deportivo Argentino", "9 de Julio (Rafaela)"], up: 3, down: 3 }
                ]
            },
            {
                id: 4, name: "Nivel 4: Primera C", divisions: [
                    { id: crypto.randomUUID(), name: "Primera C (27)", teams: ["Berazategui", "Luján", "General Lamadrid", "Muñiz", "Justo José de Urquiza (JJ Urquiza)", "Leandro N. Alem", "Deportivo Paraguayo", "Yupanqui", "Puerto Nuevo", "Victoriano Arenas", "Estrella del Sur", "Defensores de Cambaceres", "El Porvenir", "Juventud Unida", "Centro Español", "Argentino (R)", "Claypole", "Central Córdoba (R)", "Ituzaingó", "Camioneros", "Mercedes", "Atlas", "Lugano", "Central Ballester", "Sportivo Barracas", "El Linqueño", "San Martín (F)"], up: 3, down: 3 }
                ]
            },
            {
                id: 5, name: "Nivel 5: Promocional Amateur", divisions: [
                    { id: crypto.randomUUID(), name: "Promocional Amateur (12)", teams: ["SAT (Sindicato Argentino de Televisión)", "Estrella de Berisso", "Juventud de Bernal", "Atlético Pilar", "Ezeiza FC", "Barrancas FC", "Defensores de Glew", "Provincial de Lobos", "Belgrano de Zárate", "Everton de La Plata", "Náutico Hacoaj", "Deportivo Metalúrgico"], up: 3, down: 0 }
                ]
            }
        ];

        // Estado Reactivo de la Aplicación
        let appStructure = JSON.parse(JSON.stringify(defaultStructure)); // Usar una copia profunda
        let openAccordions = [];
        let simulationHistory = [];

        // Elementos del DOM
        const structureContainer = () => document.getElementById('structure-container');
        const historyContainer = () => document.getElementById('history-container');
        const messageBox = () => document.getElementById('message-box');
        const messageText = () => document.getElementById('message-text');

        // --- Funciones de Utilidad ---

        /** Muestra un mensaje temporal en la UI. */
        function showMessage(text, isError = false) {
            messageText().textContent = text;
            messageBox().className = `p-3 rounded-xl shadow-lg mb-4 text-center ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} transition-opacity duration-300`;
            messageBox().classList.remove('opacity-0', 'hidden');
            messageBox().classList.add('opacity-100');

            if (!isError) {
                setTimeout(() => {
                    messageBox().classList.remove('opacity-100');
                    messageBox().classList.add('opacity-0');
                    setTimeout(() => messageBox().classList.add('hidden'), 300);
                }, 4000);
            }
        }

        /** Inicializa la autenticación y el listener de Firestore. */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config no está disponible.");
                showMessage("Error: Configuración de Firebase no disponible.", true);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticar al usuario
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Esperar el cambio de estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado. UID:", userId);
                        isAuthReady = true;
                        // Iniciar el listener de Firestore después de la autenticación
                        setupFirestoreListener();
                    } else {
                        userId = crypto.randomUUID();
                        console.log("Sesión anónima o token no disponible. Usando ID temporal:", userId);
                        isAuthReady = true;
                        // Iniciar el listener de Firestore de todas formas, aunque con ID temporal
                        setupFirestoreListener();
                    }
                    renderApp(); // Renderizar después de saber el ID de usuario
                });

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                showMessage(`Error de Firebase: ${error.message}`, true);
            }
        }

        /** Configura el listener de tiempo real (onSnapshot). */
        function setupFirestoreListener() {
            if (!db) {
                console.error("Firestore no inicializado.");
                return;
            }

            const simDocRef = doc(db, SIMULATION_DOC_PATH);

            onSnapshot(simDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    try {
                        appStructure = JSON.parse(data.structure);
                        openAccordions = JSON.parse(data.openAccordions || '[]');
                        simulationHistory = JSON.parse(data.history || '[]');
                        console.log("Simulación cargada exitosamente desde Firestore.");
                    } catch (e) {
                        console.error("Error al parsear datos de Firestore:", e);
                        showMessage("Error al cargar la simulación: datos corruptos.", true);
                        appStructure = JSON.parse(JSON.stringify(defaultStructure));
                    }
                } else {
                    console.log("No se encontró simulación. Usando estructura por defecto.");
                    appStructure = JSON.parse(JSON.stringify(defaultStructure));
                }
                renderApp();
            }, (error) => {
                console.error("Error al cargar la simulación:", error);
                // NOTA: Es importante NO usar confirm/alert. Usamos la función showMessage.
                showMessage(`Error al cargar la simulación: ${error.message}`, true);
                appStructure = JSON.parse(JSON.stringify(defaultStructure)); // Volver al estado por defecto si falla la carga
                renderApp();
            });
        }

        /** Guarda el estado actual de la simulación en Firestore. */
        async function saveStructure() {
            if (!db || !isAuthReady) {
                console.warn("Firestore no listo o autenticación pendiente. No se guardará.");
                return;
            }

            const simDocRef = doc(db, SIMULATION_DOC_PATH);
            const dataToSave = {
                structure: JSON.stringify(appStructure),
                openAccordions: JSON.stringify(openAccordions),
                history: JSON.stringify(simulationHistory),
                lastUpdated: new Date().toISOString()
            };

            try {
                // Usamos setDoc con merge: true si el documento puede no existir.
                await setDoc(simDocRef, dataToSave, { merge: true });
                showMessage("Estructura guardada exitosamente.");
            } catch (error) {
                console.error("Error al guardar la estructura:", error);
                showMessage(`Error al guardar la estructura: ${error.message}`, true);
            }
        }

        /** Renderiza un equipo dentro de una división. */
        function renderTeam(teamName, divisionId) {
            return `
                <div class="flex items-center justify-between p-1 bg-white hover:bg-gray-50 transition duration-150 rounded-lg shadow-sm">
                    <span class="text-sm font-medium text-gray-700 truncate">${teamName}</span>
                    <div class="flex space-x-1">
                        <button onclick="moveTeam('${teamName}', '${divisionId}', -1)" class="text-gray-400 hover:text-gray-700 transition duration-150 p-1 rounded-full hover:bg-gray-100" title="Subir equipo">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                        </button>
                        <button onclick="moveTeam('${teamName}', '${divisionId}', 1)" class="text-gray-400 hover:text-gray-700 transition duration-150 p-1 rounded-full hover:bg-gray-100" title="Bajar equipo">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                        </button>
                        <button onclick="removeTeam('${teamName}', '${divisionId}')" class="text-red-400 hover:text-red-600 transition duration-150 p-1 rounded-full hover:bg-red-100" title="Eliminar equipo">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        /** Renderiza una división dentro de un nivel. */
        function renderDivision(division, levelId) {
            const isFederal = division.name.includes("Federal");
            const totalTeams = division.teams.length;

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 transition duration-300 hover:shadow-xl">
                    <h4 class="text-lg font-semibold text-gray-900 mb-2 border-b pb-2 flex justify-between items-center">
                        <span>${division.name} (${totalTeams} equipos)</span>
                        <button onclick="toggleDivisionAccordion('${division.id}')" class="text-blue-500 hover:text-blue-700 transition duration-150">
                            ${openAccordions.includes(division.id) ? 
                                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>` : 
                                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`
                            }
                        </button>
                    </h4>
                    
                    <div class="text-sm text-gray-600 mb-3 space-y-1">
                        <p class="flex justify-between">
                            <span class="font-medium text-green-600">Ascensos (UP):</span> 
                            <input type="number" min="0" value="${division.up}" onchange="updatePromotionRelegation(${levelId}, '${division.id}', 'up', this.value)" class="w-16 p-1 border rounded-md text-right text-gray-700 focus:ring-blue-500 focus:border-blue-500">
                        </p>
                        <p class="flex justify-between">
                            <span class="font-medium text-red-600">Descensos (DOWN):</span>
                            <input type="number" min="0" value="${division.down}" onchange="updatePromotionRelegation(${levelId}, '${division.id}', 'down', this.value)" class="w-16 p-1 border rounded-md text-right text-gray-700 focus:ring-blue-500 focus:border-blue-500">
                        </p>
                    </div>

                    ${openAccordions.includes(division.id) ? `
                        <div id="division-teams-${division.id}" class="space-y-2 mt-4 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                            ${division.teams.map(team => renderTeam(team, division.id)).join('')}
                        </div>
                        <div class="mt-4 pt-3 border-t">
                            <div class="flex space-x-2">
                                <input type="text" id="add-team-input-${division.id}" placeholder="Nombre del equipo" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <button onclick="addTeam('${division.id}')" class="px-4 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition duration-150 text-sm shadow-md">
                                    <svg class="w-5 h-5 inline-block -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Añadir
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        /** Renderiza un nivel (conjunto de divisiones). */
        function renderLevel(level) {
            return `
                <div class="mb-8 border-2 border-indigo-400 rounded-2xl p-6 bg-indigo-50 shadow-2xl">
                    <h3 class="text-3xl font-extrabold text-indigo-700 mb-6 border-b-4 border-indigo-300 pb-3">${level.name}</h3>
                    
                    <div class="grid md:grid-cols-${level.divisions.length > 1 ? '2' : '1'} gap-6">
                        ${level.divisions.map(division => renderDivision(division, level.id)).join('')}
                    </div>

                    ${level.divisions.length > 1 ? `
                        <p class="mt-4 text-sm text-gray-600 italic">Este nivel tiene divisiones paralelas (Metropolitana y Federal). Los ascensos y descensos se manejarán entre los niveles adyacentes si se aplica el simulador de "Impacto".</p>
                    ` : ''}

                    <div class="mt-6 pt-4 border-t border-indigo-200">
                        <button onclick="addDivision(${level.id})" class="px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition duration-150 text-sm shadow-md">
                            <svg class="w-5 h-5 inline-block -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Añadir División
                        </button>
                        <button onclick="removeLevel(${level.id})" class="ml-3 px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition duration-150 text-sm shadow-md">
                            <svg class="w-5 h-5 inline-block -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Eliminar Nivel
                        </button>
                    </div>
                </div>
            `;
        }
        
        /** Renderiza la lista de eventos de la simulación. */
        function renderHistory() {
            if (historyContainer()) {
                historyContainer().innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Historial de Simulación</h3>
                    ${simulationHistory.length > 0 ? `
                        <ul class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                            ${simulationHistory.map(item => `
                                <li class="p-2 text-sm bg-gray-100 rounded-lg border border-gray-200">${new Date(item.timestamp).toLocaleTimeString()} - ${item.action}</li>
                            `).reverse().join('')}
                        </ul>
                        <button onclick="clearHistory()" class="mt-4 px-3 py-1 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition duration-150 text-sm shadow-md">Limpiar Historial</button>
                    ` : `
                        <p class="text-gray-500 italic">No hay acciones registradas aún.</p>
                    `}
                `;
            }
        }

        /** Renderiza la aplicación completa. */
        function renderApp() {
            if (!structureContainer()) return;

            // Renderizar la estructura
            structureContainer().innerHTML = appStructure.map(renderLevel).join('');

            // Actualizar información general
            const totalTeams = appStructure.flatMap(level => level.divisions.flatMap(d => d.teams)).length;
            document.getElementById('total-levels').textContent = appStructure.length;
            document.getElementById('total-teams').textContent = totalTeams;
            document.getElementById('user-id-display').textContent = userId;

            // Renderizar el historial
            renderHistory();
        }

        // --- Lógica de Modificación de la Estructura (Acciones) ---

        /** Añade un evento al historial y guarda la estructura. */
        function recordAction(action) {
            simulationHistory.push({ action, timestamp: new Date().toISOString() });
            saveStructure();
        }

        /** Alterna el acordeón de una división. */
        window.toggleDivisionAccordion = function(divisionId) {
            const index = openAccordions.indexOf(divisionId);
            if (index > -1) {
                openAccordions.splice(index, 1);
            } else {
                openAccordions.push(divisionId);
            }
            renderApp();
            saveStructure(); // Guardar el estado de los acordeones
        }

        /** Actualiza los valores de ascenso o descenso. */
        window.updatePromotionRelegation = function(levelId, divisionId, type, value) {
            const level = appStructure.find(l => l.id === levelId);
            if (level) {
                const division = level.divisions.find(d => d.id === divisionId);
                if (division) {
                    const numValue = parseInt(value) || 0;
                    if (type === 'up') {
                        division.up = numValue;
                        recordAction(`Ascensos de ${division.name} ajustados a ${numValue}`);
                    } else if (type === 'down') {
                        division.down = numValue;
                        recordAction(`Descensos de ${division.name} ajustados a ${numValue}`);
                    }
                }
            }
        }

        /** Añade un nuevo nivel. */
        window.addLevel = function() {
            const newLevel = {
                id: Math.max(...appStructure.map(l => l.id), 0) + 1,
                name: `Nivel ${appStructure.length + 1}: Nuevo Nivel`,
                divisions: [
                    { id: crypto.randomUUID(), name: `División Única (${appStructure.length + 1})`, teams: [], up: 0, down: 0 }
                ]
            };
            appStructure.push(newLevel);
            renderApp();
            recordAction(`Nivel ${newLevel.id} agregado`);
        }

        /** Elimina un nivel. */
        window.removeLevel = function(levelId) {
            const levelIndex = appStructure.findIndex(l => l.id === levelId);
            if (levelIndex > -1) {
                const teamsToReallocate = appStructure[levelIndex].divisions.flatMap(d => d.teams);
                
                if (teamsToReallocate.length > 0) {
                    showMessage(`Error: El Nivel ${levelId} aún tiene ${teamsToReallocate.length} equipos. Reasigna o elimina los equipos primero.`, true);
                    return;
                }

                appStructure.splice(levelIndex, 1);
                appStructure.forEach((level, index) => level.id = index + 1); // Reajustar IDs
                renderApp();
                recordAction(`Nivel ${levelId} eliminado y reajustados IDs`);
            }
        }

        /** Añade una nueva división a un nivel. */
        window.addDivision = function(levelId) {
            const level = appStructure.find(l => l.id === levelId);
            if (level) {
                const newDivision = {
                    id: crypto.randomUUID(),
                    name: `División Paralela ${level.divisions.length + 1}`,
                    teams: [],
                    up: 0,
                    down: 0
                };
                level.divisions.push(newDivision);
                renderApp();
                recordAction(`Nueva división en Nivel ${levelId} agregada`);
            }
        }

        /** Añade un equipo a una división. */
        window.addTeam = function(divisionId) {
            const input = document.getElementById(`add-team-input-${divisionId}`);
            const teamName = input.value.trim();

            if (teamName) {
                const division = appStructure.flatMap(l => l.divisions).find(d => d.id === divisionId);
                if (division) {
                    if (division.teams.includes(teamName)) {
                        showMessage(`El equipo '${teamName}' ya está en esta división.`, true);
                        return;
                    }
                    division.teams.push(teamName);
                    input.value = '';
                    renderApp();
                    recordAction(`Equipo '${teamName}' agregado a ${division.name}`);
                }
            } else {
                showMessage("Por favor, ingresa el nombre de un equipo.", true);
            }
        }

        /** Mueve un equipo hacia arriba o abajo entre niveles/divisiones. */
        window.moveTeam = function(teamName, currentDivisionId, direction) {
            const allDivisions = appStructure.flatMap(level => level.divisions.map(d => ({ ...d, levelId: level.id, levelName: level.name })));
            const currentDivisionIndex = allDivisions.findIndex(d => d.id === currentDivisionId);
            
            if (currentDivisionIndex === -1) return;

            // 1. Encontrar la división de destino
            let targetDivisionIndex = currentDivisionIndex + direction;
            let targetDivision = null;
            let targetDivisionLevel = null;

            while (targetDivisionIndex >= 0 && targetDivisionIndex < allDivisions.length) {
                const potentialTarget = allDivisions[targetDivisionIndex];
                
                // Si el movimiento es entre niveles (cambio de levelId)
                if (potentialTarget.levelId !== allDivisions[currentDivisionIndex].levelId) {
                    // Si se mueve hacia arriba (direction = -1), el destino es la última división del nivel anterior.
                    // Si se mueve hacia abajo (direction = 1), el destino es la primera división del nivel siguiente.
                    
                    const targetLevel = appStructure.find(l => l.id === potentialTarget.levelId);
                    if (targetLevel.divisions.length > 0) {
                        targetDivision = direction === -1 ? 
                            targetLevel.divisions[targetLevel.divisions.length - 1] : 
                            targetLevel.divisions[0];
                        targetDivisionLevel = targetLevel.name;
                        break;
                    }
                }
                
                // Si el movimiento es lateral dentro del mismo nivel (cambio de division id)
                if (potentialTarget.levelId === allDivisions[currentDivisionIndex].levelId && potentialTarget.id !== currentDivisionId) {
                    targetDivision = potentialTarget;
                    targetDivisionLevel = potentialTarget.levelName;
                    break;
                }

                // Continuar buscando
                targetDivisionIndex += direction;
            }

            if (!targetDivision) {
                showMessage(`No se puede mover el equipo '${teamName}' ${direction === -1 ? 'más arriba' : 'más abajo'}.`, true);
                return;
            }

            // 2. Ejecutar el movimiento
            const currentDivision = allDivisions[currentDivisionIndex];
            
            // Remover de la división actual
            const sourceLevel = appStructure.find(l => l.id === currentDivision.levelId);
            const sourceDivision = sourceLevel.divisions.find(d => d.id === currentDivisionId);
            sourceDivision.teams = sourceDivision.teams.filter(t => t !== teamName);

            // Añadir a la división de destino
            const destLevel = appStructure.find(l => l.id === targetDivision.levelId);
            const destDivision = destLevel.divisions.find(d => d.id === targetDivision.id);
            destDivision.teams.push(teamName);
            destDivision.teams.sort(); // Opcional: mantener el orden alfabético

            renderApp();
            const actionText = direction === -1 ? `promovido de ${currentDivision.name} a ${destDivision.name} (${targetDivisionLevel})` : 
                                                `descendido de ${currentDivision.name} a ${destDivision.name} (${targetDivisionLevel})`;
            recordAction(`Equipo '${teamName}' ${actionText}`);
        }

        /** Elimina un equipo de una división. */
        window.removeTeam = function(teamName, divisionId) {
            const division = appStructure.flatMap(l => l.divisions).find(d => d.id === divisionId);
            if (division) {
                division.teams = division.teams.filter(t => t !== teamName);
                renderApp();
                recordAction(`Equipo '${teamName}' eliminado de ${division.name}`);
            }
        }

        /** Reinicia la simulación a la estructura por defecto. */
        window.resetStructure = function() {
             // NOTA: En un entorno de producción, esto debería ser un modal de confirmación, no un alert.
             if (window.confirm("¿Estás seguro que quieres reiniciar la estructura a los valores por defecto? Se perderán los cambios no guardados en la versión guardada en la nube.")) {
                appStructure = JSON.parse(JSON.stringify(defaultStructure));
                simulationHistory = [];
                openAccordions = [];
                renderApp();
                saveStructure();
                showMessage("Estructura reiniciada a los valores por defecto.");
            }
        }
        
        /** Limpia el historial de acciones. */
        window.clearHistory = function() {
            simulationHistory = [];
            renderApp();
            saveStructure();
        }

        // Inicializar la aplicación al cargar la ventana
        window.onload = initializeFirebase;

    </script>
    <style>
        /* Estilos personalizados para la barra de desplazamiento */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
            border-radius: 4px;
        }
        /* Ajuste para el número de columnas de la rejilla de divisiones */
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans p-4 sm:p-8">

    <!-- Encabezado y Meta-información -->
    <header class="text-center mb-10">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-800">
            Simulador de Reestructuración de Ligas Argentinas
        </h1>
        <p class="text-lg text-gray-600 mt-2">Diseña y prueba tu propio sistema de ascensos/descensos.</p>
        <div class="mt-4 text-sm text-gray-500">
            <span>Usuario ID: <strong id="user-id-display" class="font-mono text-gray-800">Cargando...</strong></span>
        </div>
    </header>

    <!-- Caja de Mensajes (No se usa alert/confirm) -->
    <div id="message-box" class="opacity-0 hidden max-w-4xl mx-auto">
        <p id="message-text"></p>
    </div>

    <!-- Panel de Control y Resumen -->
    <div class="max-w-4xl mx-auto mb-10 bg-white p-6 rounded-2xl shadow-xl border border-indigo-100">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">Resumen y Control</h2>
        <div class="flex flex-col sm:flex-row justify-around items-center space-y-4 sm:space-y-0 text-center">
            <p class="text-gray-700">Niveles: <strong id="total-levels" class="text-indigo-600 text-xl">0</strong></p>
            <p class="text-gray-700">Equipos Totales: <strong id="total-teams" class="text-indigo-600 text-xl">0</strong></p>
            <div class="flex space-x-3">
                <button onclick="addLevel()" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition duration-300 shadow-lg">
                    <svg class="w-5 h-5 inline-block -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Añadir Nivel
                </button>
                <button onclick="resetStructure()" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-300 shadow-lg">
                    <svg class="w-5 h-5 inline-block -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356-2A8.001 8.001 0 004.582 19.42M20 20v-5h-.581m0 0a8.003 8.003 0 01-15.357-2.122"></path></svg>
                    Reiniciar
                </button>
            </div>
        </div>
    </div>

    <!-- Contenedor de la Estructura de Ligas -->
    <main id="structure-container" class="max-w-4xl mx-auto"></main>

    <!-- Historial de Acciones -->
    <div class="max-w-4xl mx-auto mt-10 p-6 bg-gray-200 rounded-2xl shadow-inner" id="history-container">
        <!-- El historial se renderiza aquí -->
    </div>

    <footer class="text-center mt-8 text-xs text-gray-400">
        <p>Simulador Dinámico - Desarrollado con Firebase Firestore y Tailwind CSS.</p>
    </footer>

</body>
</html>
